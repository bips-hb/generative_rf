---
title: "SDV Benchmark (manually)"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reticulate)
source("generative_ranger.R")
library(doParallel)
registerDoParallel()
```

```{python, include=FALSE}
import numpy as np
from sdv.tabular import GaussianCopula
import sdgym
from sdgym.synthesizers import Independent
from sdgym.synthesizers import Identity
```

```{r, include=FALSE}
my_generative_ranger <- function(x) {
  x_r <- py_to_r(x)
  generative_ranger(x_real = x_r, x_synth = NULL, n_new = nrow(x_r),
                    num.trees = 10, min.node.size = 50)
}
```


```{python}
def gen_rf(real_data, metadata):
    table_name = metadata.get_tables()[0]
    return {table_name: r.my_generative_ranger(real_data[table_name])}

```

# Generative RF
```{python}
from sdgym.datasets import load_dataset
from sdgym.datasets import load_tables
from sdv.metrics.tabular import BinaryDecisionTreeClassifier,BinaryAdaBoostClassifier,BinaryLogisticRegression,BinaryMLPClassifier
from sklearn.metrics import f1_score

metadata = load_dataset('adult')
tables = load_tables(metadata)
table_name = metadata.get_tables()[0]
real_data = tables['adult']#[1:100]

synth_data  = gen_rf(real_data={"adult": real_data}, metadata=metadata)

BinaryDecisionTreeClassifier.compute(real_data, synth_data["adult"], target = "label", scorer=f1_score)
BinaryAdaBoostClassifier.compute(real_data, synth_data["adult"], target = "label", scorer=f1_score)
BinaryLogisticRegression.compute(real_data, synth_data["adult"], target = "label", scorer=f1_score)
BinaryMLPClassifier.compute(real_data, synth_data["adult"], target = "label", scorer=f1_score)

```

# CTGAN
```{python}
from sdv.tabular import CTGAN

model = CTGAN()
model.fit(real_data)

synth_data = model.sample(real_data.shape[0])

BinaryDecisionTreeClassifier.compute(real_data, synth_data, target = "label", scorer=f1_score)
BinaryAdaBoostClassifier.compute(real_data, synth_data, target = "label", scorer=f1_score)
BinaryLogisticRegression.compute(real_data, synth_data, target = "label", scorer=f1_score)
BinaryMLPClassifier.compute(real_data, synth_data, target = "label", scorer=f1_score)
```

# Identity
```{python}
BinaryDecisionTreeClassifier.compute(real_data, real_data, target = "label", scorer=f1_score)
BinaryAdaBoostClassifier.compute(real_data, real_data, target = "label", scorer=f1_score)
BinaryLogisticRegression.compute(real_data, real_data, target = "label", scorer=f1_score)
BinaryMLPClassifier.compute(real_data, real_data, target = "label", scorer=f1_score)
```

# ------------------------------------------
# Replicate  Xu et al. 2020 benchmark study
# ------------------------------------------
# evaluating real data sets, table 5
# using a train/test split, table 4

# trying to avoid as much copy-paste as possible:
````{python}
from sklearn.model_selection import train_test_split

class benchmark:
    def __init__(self, dataset, test_size, model, metric = f1_score):
        self.metadata = load_dataset(dataset)
        self.real_data = load_tables(self.metadata)[dataset][1:200] # comment out subset later
        self.real_data_train, self.real_data_test = train_test_split(self.real_data, test_size=test_size, random_state=2022)
        self.model = model
        self.metric = metric
        
    def synth_data(self):
        self.model.fit(self.real_data_train)
        return self.model.sample(self.real_data_test.shape[0])
      
    def scores(self, list_of_classifiers):
        syn_dat = self.synth_data()
        res = {}
        for item in list_of_classifiers:
            res[item.__name__]=item.compute(self.real_data_test, syn_dat, target = "label", scorer = self.metric)
        return res
   
example = benchmark(dataset= 'adult', test_size=10/33, model=CTGAN())
#synthetic_data = ex.synth_data()
example.scores(list_of_classifiers=[BinaryDecisionTreeClassifier,BinaryAdaBoostClassifier, BinaryLogisticRegression,BinaryMLPClassifier ])

````
# used data sets & metrics 
```{python}
list_of_classifiers = [BinaryDecisionTreeClassifier, BinaryAdaBoostClassifier,BinaryLogisticRegression, BinaryMLPClassifier]
```
# to do: list all combinations of data sets/classifiers; integrate generative_rf in class framework
